<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- vet.encounter.head  -->
    <record id="vet_encounter_header_view_list" model="ir.ui.view">
        <field name="name">vet.encounter.header.list</field>
        <field name="model">vet.encounter.header</field>
        <field name="arch" type="xml">
            <list string="Encounters" decoration-info="state=='in_progress'" decoration-success="state=='done'" decoration-warning="pending_payments==True">
                <field name="name"/>
                <field name="encounter_date" widget="date"/>
                <field name="partner_id" optional="show"/>
                <field name="pet_owner_id" optional="hide"/>
                <field name="patient_ids" string="Pets" widget="many2many_tags"/>
                <field name="pets_summary" string="Pets Summary" optional="show"/>
                <field name="practitioner_id" optional="show"/>
                <field name="room_id" optional="show"/>
                <field name="total_amount" sum="Total Amount" widget="monetary" options="{'currency_field': 'company_currency'}"/>
                <field name="paid_amount" string="Paid" sum="Total Paid" widget="monetary" optional="show" options="{'currency_field': 'company_currency'}"/>
                <field name="pending_amount" string="Pending" sum="Total Pending" widget="monetary" optional="show" options="{'currency_field': 'company_currency'}"/>
                <field name="pending_payments" string="Has Pending" widget="boolean_toggle" optional="show"/>
                <field name="total_pets_count" optional="hide" string="# Pets"/>
                <field name="all_pets_species" optional="hide" string="Species"/>
                <field name="state" widget="badge" decoration-success="state == 'done'" decoration-info="state == 'in_progress'"/>
                <field name="company_currency" column_invisible="1"/>
                <!-- Quick Action Buttons -->
                <button name="action_view_appointments" string="Appointments" type="object" icon="fa-calendar" invisible="not appointment_ids"/>
                <button name="action_view_pos_orders" string="POS" type="object" icon="fa-shopping-cart" invisible="not pos_order_ids"/>
            </list>
        </field>
    </record>

    <record id="vet_encounter_header_view_form" model="ir.ui.view">
        <field name="name">vet.encounter.header.form</field>
        <field name="model">vet.encounter.header</field>
        <field name="arch" type="xml">
            <form string="Encounter">
                <header>
                    <field name="state" widget="statusbar" options="{'clickable': '1'}" statusbar_visible="in_progress,done" readonly="0"/>
                    <button name="action_create_invoice_from_pending_lines" type="object" string="Create Invoice" class="btn-primary" invisible="pending_amount == 0"/>
                    <button name="action_create_sale_order_from_pending_lines" type="object" string="Create Sale Order" class="btn-secondary" invisible="pending_amount == 0"/>
                    <button name="action_refresh_all_payment_status" type="object" string="Refresh Payment Status" class="btn-secondary"/>
                    <button name="action_auto_close_empty_encounters" type="object" string="Auto-Close if Empty" class="btn-warning" invisible="state != 'in_progress'"/>
                </header>
                <div class="alert alert-success" role="alert" invisible="pending_amount != 0 or total_amount == 0">
                    <strong>âœ… Fully Paid:</strong>
                    Paid: <field name="paid_amount" readonly="1"/> |
                    Total: <field name="total_amount" readonly="1"/>
                </div>

                <div class="alert alert-warning" role="alert" invisible="pending_amount == 0 or paid_amount == 0 or total_amount == 0">
                    <strong>âš ï¸ Partial Payment:</strong>
                    Pending: <field name="pending_amount" readonly="1"/> |
                    Paid: <field name="paid_amount" readonly="1"/> |
                    Total: <field name="total_amount" readonly="1"/>
                </div>

                <div class="alert alert-info" role="alert" invisible="pending_amount == 0 or paid_amount != 0 or total_amount == 0">
                    <strong>ğŸ’° Payment Pending:</strong>
                    Pending: <field name="pending_amount" readonly="1"/> |
                    Total: <field name="total_amount" readonly="1"/>
                </div>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_appointments" type="object" icon="fa-calendar" class="oe_stat_button" invisible="not appointment_ids">
                            <field name="appointment_ids" widget="statinfo" string="Appointments"/>
                        </button>
                        <button class="oe_stat_button" type="object" name="action_view_pet_medical_histories" icon="fa-paw" invisible="not patient_ids">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Pet Medical</span>
                                <span class="o_stat_text">History</span>
                            </div>
                        </button>
                        <button name="action_view_boarding_stays" type="object" icon="fa-bed" class="oe_stat_button" invisible="not boarding_stay_ids">
                            <field name="boarding_stay_ids" widget="statinfo" string="Boarding"/>
                        </button>
                        <button name="action_view_vaccinations" type="object" icon="fa-syringe" class="oe_stat_button" invisible="not vaccination_ids">
                            <field name="vaccination_ids" widget="statinfo" string="Vaccinations"/>
                        </button>
                        <button class="oe_stat_button" type="object" name="action_view_documents" icon="fa-camera" invisible="documents_count == 0">
                            <field name="documents_count" widget="statinfo" string="Photos"/>
                        </button>
                        <button name="action_schedule_follow_up_for_pets" type="object" icon="fa-calendar" class="oe_stat_button">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Schedule</span>
                                <span class="o_stat_text">Follow-up</span>
                            </div>
                        </button>
                        <button name="action_create_treatment_plan" type="object" icon="oi-smile-add" class="oe_stat_button">
                            <field name="treatment_plan_count" widget="statinfo" string="Treatment Plan"/>
                        </button>
                        <button name="action_view_invoices" type="object" class="oe_stat_button" icon="fa-file-text-o" invisible="invoice_count == 0">
                            <field name="invoice_count" widget="statinfo" string="Invoices"/>
                        </button>
                        <button name="action_view_sale_orders" type="object" class="oe_stat_button" icon="fa-shopping-cart" invisible="sale_order_count == 0">
                            <field name="sale_order_count" widget="statinfo" string="Sales Orders"/>
                        </button>
                        <button name="action_view_pos_orders" type="object" class="oe_stat_button" icon="fa-credit-card" invisible="pos_order_count == 0">
                            <field name="pos_order_count" widget="statinfo" string="POS Orders"/>
                        </button>
                        <button name="action_view_credit_notes" type="object" class="oe_stat_button" icon="fa-file-text-o" invisible="credit_note_count == 0">
                            <field name="credit_note_count" widget="statinfo" string="Refunds"/>
                        </button>
                    </div>

                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group name="encounter_info">
                        <group string="Encounter Information" name="col_1">
                            <field name="encounter_date"/>
                            <field name="partner_id" string="Pet Owner (Billing)" options="{'open_create': True}" help="Pet owner responsible for billing"/>
                            <field name="patient_ids" string="Pets" options="{'open_create': True}" widget="many2many_tags" help="Pets receiving veterinary care"/>
                            <field name="practitioner_id" string="Practitioner" options="{'no_create': True, 'no_quick_create': True, 'no_open': True}"/>
                            <field name="room_id" options="{'no_create': True, 'no_quick_create': True, 'no_open': True}" string="Treatment Room" domain="room_id_domain"/>
                            <field name="partner_mobile" readonly="1" string="Mobile" help="Mobile number of the partner"/>
                        </group>
                        <group string="Payment Information" name="col_2">
                            <group name="lines_payment_info" string="Lines Payments">
                                <field name="pending_amount" readonly="1" widget="monetary" string="Pending Amount" options="{'currency_field': 'company_currency'}"/>
                                <field name="paid_amount" readonly="1" widget="monetary" options="{'currency_field': 'company_currency'}"/>
                                <field name="total_amount" widget="monetary" options="{'currency_field': 'company_currency'}"/>
                                <field name="returned_amount" widget="monetary" invisible="not returned_amount" options="{'currency_field': 'company_currency'}"/>
                                <field name="pending_payments" readonly="1" widget="boolean_toggle" string="Has Pending Payments"/>
                                <field name="invoice_count" invisible="1"/>
                                <field name="sale_order_count" invisible="1"/>
                                <field name="pos_order_count" invisible="1"/>
                                <field name="company_currency" invisible="1"/>
                            </group>
                        </group>
                    </group>
                    <group string="Internal Notes" name="internal_notes">
                        <field name="notes" placeholder="Add internal administrative notes here..."/>
                    </group>
                    <notebook>
                        <page string="Billing">
                            <group string="Encounter Lines">
                                <field name="encounter_line_ids" context="{'default_encounter_id': id}" nolabel="1"/>
                            </group>
                            <group string="POS Order">
                                <field name="pos_order_ids" context="{'default_encounter_id': id}" nolabel="1"/>
                            </group>
                            <group string="Direct Invoices">
                                <field name="direct_invoice_ids" nolabel="1" readonly="1" context="{'default_encounter_id': id}" view_mode="list,form">
                                </field>
                            </group>
                            <group string="Credit Notes/Refunds">
                                <field name="credit_note_ids" nolabel="1" readonly="1" context="{'default_move_type': 'out_refund', 'default_encounter_id': id}"
                                       decoration-danger="name">
                                    <!--                                    <list create="false" edit="false">-->
                                    <!--                                        <field name="name"/>-->
                                    <!--                                        <field name="invoice_date" string="Date"/>-->
                                    <!--                                        <field name="encounter_id" optional="hide"/>-->
                                    <!--                                        <field name="partner_id" string="Pet Owner"/>-->
                                    <!--                                        <field name="patient_ids" widget="many2many_tags" optional="hide"/>-->
                                    <!--                                        <field name="practitioner_id" optional="hide"/>-->
                                    <!--                                        <field name="room_id" optional="hide"/>-->
                                    <!--                                        <field name="amount_total" decoration-danger="amount_total &lt; 0" widget="monetary" options="{'currency_field': 'company_currency'}"/>-->
                                    <!--                                        <field name="state"/>-->
                                    <!--                                        <field name="payment_state"/>-->
                                    <!--                                        <field name="payment_journal_name" optional="show"/>-->
                                    <!--                                        <field name="payment_method_name" optional="hide"/>-->
                                    <!--                                        <field name="reversed_entry_id" string="Original Invoice"/>-->
                                    <!--                                    </list>-->
                                </field>
                            </group>
                            <group string="Sales Order">
                                <field name="sale_order_ids" context="{'default_encounter_id': id}" nolabel="1" can_write="1" can_create="true"/>
                            </group>
                        </page>
                        <page string="Services/Products" name="vet_encounter_line">
                            <field name="encounter_line_ids" nolabel="1">
                                <list editable="top">
                                    <field name="product_id" required="1"/>
                                    <field name="product_description" optional="hide"/>
                                    <field name="qty" string="Qty"/>
                                    <field name="unit_price" widget="monetary" options="{'currency_field': 'company_currency'}"/>
                                    <field name="discount" widget="percentage" optional="show"/>
                                    <field name="sub_total" readonly="1" widget="monetary" sum="Total" options="{'currency_field': 'company_currency'}" optional="show"/>
                                    <!--                                    <field name="commission_pct" optional="hide"/>-->
                                    <field name="partner_id" optional="hide" readonly="0"/>
                                    <field name="patient_ids" optional="show" widget="many2many_tags"/>
                                    <field name="practitioner_id" options="{'no_open': True}" required="0"/>
                                    <field name="room_id" optional="show" domain="room_id_domain"/>
                                    <field name="payment_status" widget="badge"
                                           decoration-success="payment_status == 'paid'"
                                           decoration-info="payment_status == 'pending'"
                                           decoration-warning="payment_status in ('cancelled', 'refunded')"
                                           optional="show"/>
                                    <field name="source_model" optional="show" widget="selection" decoration-info="source_model in ('calendar.event', 'manual')"
                                           decoration-primary="source_model in ('vet.boarding.stay', 'vet.vaccination')"
                                           decoration-success="source_model in ('sale.order', 'pos.order')"
                                           decoration-warning="source_model == 'vet.pet.membership'"/>
                                    <field name="encounter_id" optional="hide" required="1"/>
                                    <field name="notes" optional="hide"/>
                                    <field name="company_currency" column_invisible="1"/>
                                </list>
                            </field>
                        </page>
                        <page string="Appointments" name="appointments">
                            <field name="appointment_ids" nolabel="1" readonly="0"
                                   context="{'default_appointment_type_id': default_appointment_type_id if default_appointment_type_id else False,
                                             'default_pet_owner_id': partner_id or pet_owner_id or False}">
                                <list create="true" edit="true" editable="bottom"
                                      decoration-success="appointment_status in ('paid','completed')"
                                      decoration-info="appointment_status in ('request', 'booked')"
                                      decoration-warning="appointment_status == 'attended'"
                                      decoration-danger="appointment_status in ('cancelled', 'no_show')">
                                    <field name="name" readonly="1" optional="hide"/>
                                    <field name="appointment_type_id" string="Type"/>
                                    <field name="pet_owner_id" optional="hide"/>
                                    <field name="patient_ids" widget="many2many_tags"/>
                                    <field name="partner_ids" widget="many2many_tags" optional="hide"/>
                                    <field name="resource_ids" widget="many2many_tags" optional="hide"/>
                                    <field name="practitioner_id" domain="practitioner_id_domain"/>
                                    <field name="room_id" optional="show" domain="room_id_domain"/>
                                    <field name="start" widget="datetime"/>
                                    <field name="stop" widget="datetime"/>
                                    <field name="appointment_status" string="Status"/>
                                    <field name="reason_for_visit" optional="show" widget="many2many_tags"/>
                                </list>
                            </field>
                        </page>
                        <page string="Boarding Stays" name="boarding_stays">
                            <field name="boarding_stay_ids" nolabel="1" readonly="0" context="{'default_encounter_id': id}" mode="list,form" widget="one2many"/>
                            <!--                            <field name="boarding_stay_ids" nolabel="1" readonly="0" mode="list,form"-->
                            <!--                                   options="{'no_quick_create': True,'no_create_edit': False, 'no_open': False}">-->
                            <!--                                <list string="Boarding Stays"> &lt;!&ndash; create="true" edit="true" editable="top" &ndash;&gt;-->
                            <!--                                    <field name="name"/>-->
                            <!--                                    <field name="partner_id" optional="hide"/>-->
                            <!--                                    <field name="pet_owner_id" optional="hide"/>-->
                            <!--                                    <field name="patient_ids" widget="many2many_tags"/>-->
                            <!--                                    <field name="cage_id" domain="cage_domain"/>-->
                            <!--                                    <field name="check_in_datetime" widget="datetime"/>-->
                            <!--                                    <field name="expected_check_out_datetime" widget="datetime"/>-->
                            <!--                                    <field name="duration_days"/>-->
                            <!--                                    <field name="state" widget="selection_badge"/>-->
                            <!--                                    <button name="action_check_in" string="Check In" type="object" class="oe_highlight" invisible="state not in ('draft', 'scheduled')"/>-->
                            <!--                                    <button name="action_check_out" string="Check Out" type="object" class="oe_highlight" invisible="state != 'checked_in'"/>-->
                            <!--                                    <button name="action_cancel" string="Cancel Stay" type="object" invisible="state in ('checked_out', 'invoiced', 'cancelled')"/>-->
                            <!--                                    <button name="action_reset_to_draft" string="Reset to Draft" type="object" invisible="state != 'cancelled'"/>-->
                            <!--                                </list>-->
                            <!--                            </field>-->
                        </page>
                        <page string="Park Visits" name="park_visits">
                            <field name="park_checkin_ids" nolabel="1" readonly="0" context="{'default_encounter_id': id}" mode="list,form" widget="one2many"/>
                        </page>
                        <page string="Vaccinations" name="vaccinations">
                            <field name="vaccination_ids" nolabel="1" readonly="0"
                                   context="{'default_owner_id': partner_id or pet_owner_id or False, 'default_encounter_id': id,
                                    'default_pet_id': patient_ids if patient_ids else False}">
                                <list create="true" edit="true" editable="top">
                                    <field name="partner_id" optional="hide"/>
                                    <field name="pet_owner_id" optional="hide"/>
                                    <field name="patient_ids" widget="many2many_tags"/>
                                    <field name="vaccine_type_id"/>
                                    <field name="date" widget="date"/>
                                    <field name="expiry_date" widget="date"/>
                                    <field name="practitioner_id"/>
                                    <field name="is_expired" widget="boolean_toggle"/>
                                </list>
                            </field>
                        </page>

                        <page string="Clinical Data" name="clinical_data">
                            <group string="Visit Details">
                                <field name="chief_complaint" placeholder="Reason for visit..."/>
                                <field name="history_illness" placeholder="History of present illness..."/>
                                <group string="Vitals" colspan="2">
                                    <field name="vitals_log_ids" string="Vitals" readonly="0" nolabel="1"
                                           context="{'default_encounter_id': id, 'default_pet_owner_id': partner_id,'default_patient_id': patient_ids[0]}">
                                        <list create="true" edit="true" editable="top">
                                            <field name="encounter_id" required="1" optional="hide"/>
                                            <field name="pet_owner_id" optional="hide"/>
                                            <field name="patient_id"/>
                                            <field name="weight"/>
                                            <field name="height"/>
                                            <field name="temperature"/>
                                            <field name="heart_rate"/>
                                            <field name="respiratory_rate"/>
                                            <field name="notes"/>
                                            <field name="log_date" widget="date"/>
                                        </list>
                                    </field>
                                </group>
                            </group>
                            <separator string="SOAP Notes"/>
                            <group>
                                <field name="soap_subjective" placeholder="Subjective findings..."/>
                                <field name="soap_objective" placeholder="Objective findings..."/>
                                <field name="soap_assessment" placeholder="Assessment/Diagnosis..."/>
                                <field name="soap_plan" placeholder="Treatment plan, orders, follow-up..."/>
                            </group>
                            <separator string="Summaries"/>
                            <group>
                                <field name="diagnosis_text" placeholder="Summary of diagnoses..."/>
                                <field name="procedures_text" placeholder="Summary of procedures performed..."/>
                                <field name="prescriptions_text" placeholder="Summary of prescriptions issued..."/>
                                <field name="lab_orders_text" placeholder="Summary of lab tests ordered..."/>
                                <field name="radiology_orders_text" placeholder="Summary of radiology exams ordered..."/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <!-- Attachment preview -->
                <div class="o_attachment_preview"/>
                <!-- Chatter -->
                <chatter/>
            </form>
        </field>
    </record>

    <record id="view_vet_encounter_search" model="ir.ui.view">
        <field name="name">vet.encounter.header.search</field>
        <field name="model">vet.encounter.header</field>
        <field name="arch" type="xml">
            <search string="Search Encounters">
                <group expand="0" string="Search">
                    <field name="name" string="Encounter ID"/>
                    <field name="encounter_date"/>
                    <field name="appointment_ids"/>
                    <field name="partner_id" filter_domain="['|', ('partner_id', 'ilike', self), ('patient_ids', 'ilike', self)]" string="Pet Owner"/>
                    <field name="patient_ids" string="Pets"/>
                    <field name="practitioner_id"/>
                    <field name="all_pets_species" string="All Species"/>
                    <field name="pets_summary" string="Pet Summary"/>
                    <!-- Status Filters -->
                    <filter string="In Progress" name="filter_in_progress" domain="[('state', '=', 'in_progress')]"/>
                    <filter string="Done/Completed" name="filter_billed" domain="[('state', '=', 'done')]"/>
                    <separator/>
                    <!-- Payment Filters -->
                    <filter string="Has Pending Payments" name="filter_pending_payments" domain="[('pending_payments', '=', True)]"/>
                    <filter string="Fully Paid" name="filter_fully_paid" domain="[('pending_payments', '=', False)]"/>
                    <separator/>
                    <!-- Date Filters -->
                    <filter string="Today" name="filter_today" domain="[('encounter_date', '=', context_today())]"/>
                    <filter string="Yesterday" name="filter_yesterday" domain="[('encounter_date', '=', (context_today() - datetime.timedelta(days=1)).strftime('%Y-%m-%d'))]"/>
                    <filter string="This Week" name="filter_this_week" context="{'search_encounter_date_range': 'this_week'}"/>
                    <filter string="Last Week" name="filter_last_week" context="{'search_encounter_date_range': 'last_week'}"/>
                    <filter string="This Month" name="filter_this_month"
                            domain="[('encounter_date', '&gt;=', (context_today().replace(day=1)).strftime('%Y-%m-%d')), ('encounter_date', '&lt;=', context_today().strftime('%Y-%m-%d'))]"/>
                    <separator/>
                    <!-- Service Type Filters -->
                    <filter string="Has Appointments" name="filter_has_appointments" domain="[('appointment_ids', '!=', False)]"/>
                    <filter string="Has Boarding" name="filter_has_boarding" domain="[('boarding_stay_ids', '!=', False)]"/>
                    <filter string="Has Vaccinations" name="filter_has_vaccinations" domain="[('vaccination_ids', '!=', False)]"/>
                    <filter string="Has Park Visits" name="filter_has_park_visits" domain="[('park_checkin_ids', '!=', False)]"/>
                    <separator/>


                </group>
                <group expand="1" string="Group By">
                    <filter string="Date" name="groupby_date" context="{'group_by': 'encounter_date'}"/>
                    <filter string="Status" name="groupby_state" context="{'group_by': 'state'}"/>
                    <filter string="Pet Owner" name="groupby_partner" context="{'group_by': 'partner_id'}"/>
                    <filter string="Practitioner" name="groupby_practitioner" context="{'group_by': 'practitioner_id'}"/>
                    <filter string="Room" name="groupby_room" context="{'group_by': 'room_id'}"/>
                    <filter string="Species" name="groupby_species" context="{'group_by': 'all_pets_species'}"/>
                    <filter string="Payment Status" name="groupby_payment_status" context="{'group_by': 'pending_payments'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Kanban view -->
    <record id="view_vet_encounter_kanban" model="ir.ui.view">
        <field name="name">vet.encounter.header.kanban</field>
        <field name="model">vet.encounter.header</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_small_column" quick_create="false">
                <field name="name"/>
                <field name="partner_id"/>
                <field name="pet_owner_id"/>
                <field name="patient_ids"/>
                <field name="practitioner_id"/>
                <field name="room_id"/>
                <field name="state"/>
                <field name="encounter_date"/>
                <field name="pending_amount"/>
                <field name="pending_payments"/>
                <field name="total_pets_count"/>
                <field name="all_pets_species"/>
                <field name="pets_summary"/>
                <field name="pet_badge_data"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="o_kanban_record_title">
                                    <t t-esc="record.name.value"/>
                                </strong>
                                <span t-att-class="'badge badge-' + (record.state.raw_value == 'done' ? 'success' : 'info')">
                                    <t t-esc="record.state.value"/>
                                </span>
                            </div>

                            <div class="o_kanban_record_body">
                                <div>
                                    <strong>Pet Owner: </strong>
                                    <t t-esc="record.partner_id.value"/>
                                </div>
                                <div>
                                    <strong>Pets: </strong>
                                    <!-- Use pets_summary instead of iterating -->
                                    <span class="text-primary">
                                        <t t-esc="record.pets_summary.value"/>
                                    </span>
                                    <t t-if="record.all_pets_species.value">
                                        <br/>
                                        <small class="text-muted">
                                            <i class="fa fa-paw"/> <t t-esc="record.all_pets_species.value"/>
                                        </small>
                                    </t>
                                </div>
                                <div t-if="record.practitioner_id.value">
                                    <strong>Practitioner: </strong>
                                    <t t-esc="record.practitioner_id.value"/>
                                </div>
                                <div t-if="record.room_id.value">
                                    <strong>Room: </strong>
                                    <t t-esc="record.room_id.value"/>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fa fa-calendar me-1"/>
                                        <t t-esc="record.encounter_date.value"/>
                                    </small>
                                </div>
                                <div class="mt-1">
                                    <strong>Payment: </strong>
                                    <span t-att-class="'badge ' + (record.pending_payments.raw_value ? 'badge-warning' : 'badge-success')">
                                        <t t-if="record.pending_payments.raw_value">
                                            Pending: <t t-esc="record.pending_amount.value"/>
                                        </t>
                                        <t t-else="">Paid</t>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>


    <!-- Dashboard Action -->
    <record id="action_vet_encounter_dashboard" model="ir.actions.client">
        <field name="name">Encounter Dashboard</field>
        <field name="tag">vet_encounter_dashboard</field>
        <field name="target">current</field>
    </record>

    <!-- Graph View for Encounters -->
    <record id="view_vet_encounter_graph" model="ir.ui.view">
        <field name="name">vet.encounter.header.graph</field>
        <field name="model">vet.encounter.header</field>
        <field name="arch" type="xml">
            <graph string="Encounter Analytics" type="bar" stacked="True">
                <field name="encounter_date" type="row" interval="day"/>
                <field name="state" type="col"/>
                <field name="total_amount" type="measure"/>
                <field name="total_pets_count" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Pivot View for Encounters -->
    <record id="view_vet_encounter_pivot" model="ir.ui.view">
        <field name="name">vet.encounter.header.pivot</field>
        <field name="model">vet.encounter.header</field>
        <field name="arch" type="xml">
            <pivot string="Encounter Analysis">
                <field name="encounter_date" type="row" interval="month"/>
                <field name="practitioner_id" type="col"/>
                <field name="total_amount" type="measure"/>
                <field name="pending_amount" type="measure"/>
                <field name="paid_amount" type="measure"/>
                <field name="total_pets_count" type="measure"/>
            </pivot>
        </field>
    </record>

    <record id="action_medical_encounter_vet" model="ir.actions.act_window">
        <field name="name">Encounters</field>
        <field name="res_model">vet.encounter.header</field>
        <field name="view_mode">kanban,list,form,graph,pivot</field>
        <field name="search_view_id" ref="view_vet_encounter_search"/>
        <field name="context">{'search_default_filter_today': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">Create a new Encounter</p>
            <p>Encounters track all visits and activities for pets. Use this to manage daily veterinary operations.</p>
        </field>
    </record>

    <!-- TODO: Add encounter timeline view showing chronological service order -->
    <!-- TODO: Implement encounter print templates for patient summaries -->
    <!-- TODO: Implement encounter mass operations (bulk state changes) -->
    <!-- TODO: Add encounter comparison view for repeat patients -->
    <!-- TODO: Implement encounter search by service combinations -->
    <!-- TODO: Add pet species color coding in consolidated view -->
    <!-- TODO: Implement multi-pet treatment plan coordination -->
    <!-- TODO: Add pet owner contact preferences per encounter -->
    <!-- TODO: Implement pet emergency contact integration -->


    <!-- vet.encounter.line  -->
    <record id="view_vet_encounter_line_list" model="ir.ui.view">
        <field name="name">vet.encounter.line.list</field>
        <field name="model">vet.encounter.line</field>
        <field name="arch" type="xml">
            <list string="Encounter Line Items" create="false" decoration-success="payment_status == 'paid'" decoration-warning="payment_status == 'partial'"
                  decoration-info="payment_status == 'posted'" decoration-danger="payment_status == 'refunded'" decoration-muted="payment_status == 'cancelled'">
                <field name="encounter_id" optional="show"/>
                <field name="partner_id"/>
                <field name="pet_owner_id" optional="hide"/>
                <field name="patient_ids" widget="many2many_tags"/>
                <field name="product_id" readonly="fields_readonly"/>
                <field name="qty" readonly="fields_readonly"/>
                <field name="unit_price" widget="monetary" options="{'currency_field': 'company_currency'}" readonly="fields_readonly"/>
                <field name="discount" widget="percentage" optional="show" readonly="fields_readonly"/>
                <field name="sub_total" sum="Total Amount" widget="monetary" options="{'currency_field': 'company_currency'}"/>
                <field name="practitioner_id" optional="show"/>
                <field name="room_id" optional="show"/>
                <field name="paid_amount" sum="Paid" widget="monetary" options="{'currency_field': 'company_currency'}"/>
                <field name="remaining_amount" sum="Remaining" widget="monetary" options="{'currency_field': 'company_currency'}"/>
                <field name="source_model" widget="selection" optional="hide"/>
                <field name="multiple_payment_sources" optional="hide"/>
                <field name="payment_status" widget="badge" decoration-success="payment_status == 'paid'" decoration-info="payment_status in ('pending', 'posted')"
                       decoration-warning="payment_status in ('partial', 'cancelled', 'refunded')"/>
                <field name="pos_order_id" optional="hide"/>
                <field name="refunded_amount" sum="Refunded" widget="monetary" options="{'currency_field': 'company_currency'}" optional="show"/>
                <field name="is_refunded" widget="boolean_toggle" optional="show"/>
                <field name="company_currency" column_invisible="1"/>
                <button name="action_cancel" string="Cancel" type="object" icon="fa-times-circle" invisible="payment_status != 'pending'"
                        groups="account.group_account_invoice,ths_vet_base.group_vet_user,ths_vet_base.group_vet_manager"/>
                <button name="action_reset_to_pending" string="Reset" type="object" icon="fa-undo" invisible="payment_status != 'cancelled'"
                        groups="account.group_account_manager,ths_vet_base.group_vet_user,ths_vet_base.group_vet_manager"/>
                <!--                <button name="action_refunded_from_pos" string="Refund" type="object" icon="fa-undo" invisible="payment_status != 'paid'"-->
                <!--                        groups="account.group_account_manager,ths_vet_base.group_vet_user,ths_vet_base.group_vet_manager"/>-->
            </list>
        </field>
    </record>

    <record id="view_vet_encounter_line_form" model="ir.ui.view">
        <field name="name">vet.encounter.line.form</field>
        <field name="model">vet.encounter.line</field>
        <field name="arch" type="xml">
            <form string="Encounter Line Item" create="true" edit="true" delete="true">
                <header>
                    <button name="action_cancel" string="Cancel Item" type="object" invisible="payment_status != 'pending'"
                            groups="account.group_account_manager,ths_vet_base.group_vet_user,ths_vet_base.group_vet_manager"/>
                    <button name="action_reset_to_pending" string="Reset to Pending" type="object" invisible="payment_status != 'cancelled'"
                            groups="account.group_account_manager,ths_vet_base.group_vet_user,ths_vet_base.group_vet_manager"/>
                    <button name="action_refunded_from_pos" string="Refund from POS" type="object" icon="fa-undo" invisible="payment_status != 'paid'"
                            groups="account.group_account_manager,ths_vet_base.group_vet_user,ths_vet_base.group_vet_manager"/>
                    <button name="action_create_follow_up_service" string="Create Follow-up" type="object" class="oe_highlight" invisible="payment_status != 'paid'"/>
                    <field name="payment_status" widget="statusbar" statusbar_visible="pending,paid,cancelled,refunded"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_encounter" type="object" icon="fa-file-text" class="oe_stat_button" string="View Encounter"/>
                        <button name="action_view_pet_medical_history" type="object" icon="fa-history" class="oe_stat_button" string="Medical History" invisible="not patient_ids"/>
                        <button name="action_view_owner_billing_history" type="object" icon="fa-money" class="oe_stat_button" string="Billing History"/>
                    </div>
                    <group>
                        <group string="Service Information">
                            <field name="encounter_id"/>
                            <field name="product_id"/>
                            <field name="product_description" placeholder="Optional description override..."/>
                            <field name="qty" readonly="payment_status !='pending'"/>
                            <field name="unit_price" widget="monetary"/>
                            <field name="discount" widget="percentage" readonly="payment_status !='pending'"/>
                            <field name="sub_total" readonly="1" widget="monetary"/>
                        </group>
                        <group string="Assignment Information">
                            <field name="partner_id" string="Pet Owner (Billing)"/>
                            <field name="patient_ids" string="Pets" widget="many2many_tags"/>
                            <field name="practitioner_id"/>
                            <field name="room_id"/>
                        </group>
                        <group name="payment_info" string="Payment Information">
                            <field name="payment_status" widget="badge"/>
                            <field name="sub_total" widget="monetary"/>
                            <field name="paid_amount" widget="monetary"/>
                            <field name="remaining_amount" widget="monetary"/>
                            <field name="posted_amount" widget="monetary"/>
                            <field name="is_refunded" widget="boolean_toggle" readonly="1"/>
                            <field name="refunded_amount" widget="monetary" invisible="not is_refunded"/>
                        </group>
                        <group string="Processing Information">
                            <field name="source_model" widget="selection" required="1"/>
                            <field name="multiple_payment_sources"/>
                            <field name="processed_date" readonly="1" invisible="not processed_date"/>
                            <field name="processed_by" readonly="1" invisible="not processed_by"/>
                            <field name="pos_order_id" readonly="1" invisible="not pos_order_id"/>
                            <field name="sale_order_id" readonly="1" invisible="not sale_order_id"/>
                            <field name="invoice_id" readonly="1" invisible="not invoice_id"/>
                        </group>
                        <group name="payment_tracking" string="Payment Tracking" colspan="2">
                            <group string="Main Documents">
                                <field name="invoice_id"/>
                                <field name="sale_order_id"/>
                                <field name="pos_order_id"/>
                            </group>
                            <group string="All Documents">
                                <field name="invoice_ids" widget="many2many_tags"/>
                                <field name="sale_order_ids" widget="many2many_tags"/>
                                <field name="pos_order_ids" widget="many2many_tags"/>
                            </group>
                        </group>
                    </group>
                    <group string="Notes">
                        <field name="notes" nolabel="1" placeholder="Add internal notes about this service..."/>
                    </group>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <record id="view_vet_encounter_line_search" model="ir.ui.view">
        <field name="name">vet.encounter.line.search</field>
        <field name="model">vet.encounter.line</field>
        <field name="arch" type="xml">
            <search string="Search Encounter Line Items">
                <field name="encounter_id"/>
                <field name="partner_id" string="Pet Owner (Billing)"/>
                <field name="patient_ids"/>
                <field name="product_id"/>
                <field name="practitioner_id"/>
                <field name="room_id"/>
                <field name="source_model" string="Source Service"/>
                <field name="multiple_payment_sources" string="Payment Sources"/>
                <filter string="Pending" name="filter_pending" domain="[('payment_status', '=', 'pending')]"/>
                <filter string="Paid" name="filter_processed" domain="[('payment_status', '=', 'paid')]"/>
                <filter string="Cancelled" name="filter_cancelled" domain="[('payment_status', '=', 'cancelled')]"/>
                <filter string="Refunded" name="filter_refunded" domain="[('payment_status', '=', 'refunded')]"/>
                <separator/>
                <filter string="Appointments" name="filter_appointments" domain="[('source_model', '=', 'calendar.event')]"/>
                <filter string="Boarding" name="filter_boarding" domain="[('source_model', '=', 'vet.boarding.stay')]"/>
                <filter string="Vaccinations" name="filter_vaccinations" domain="[('source_model', '=', 'vet.vaccination')]"/>
                <filter string="Park Visits" name="filter_park" domain="[('source_model', '=', 'vet.park.checkin')]"/>
                <filter string="Memberships" name="filter_memberships" domain="[('source_model', '=', 'vet.pet.membership')]"/>
                <filter string="Manual Entries" name="filter_manual" domain="[('source_model', '=', 'manual')]"/>
                <separator/>
                <separator/>
                <group expand="0" string="Group By">
                    <filter string="Payment Status" name="groupby_payment_status" context="{'group_by': 'payment_status'}"/>
                    <filter string="Pet Owners" name="groupby_partner" context="{'group_by': 'partner_id'}"/>
                    <filter string="Pets" name="groupby_pets" context="{'group_by': 'patient_ids'}"/>
                    <filter string="Practitioner" name="groupby_practitioner" context="{'group_by': 'practitioner_id'}"/>
                    <filter string="Room" name="groupby_room" context="{'group_by': 'room_id'}"/>
                    <filter string="Source Service" name="groupby_source_model" context="{'group_by': 'source_model'}"/>
                    <filter string="Payment Sources" name="groupby_payment_source" context="{'group_by': 'multiple_payment_sources'}"/>
                    <filter string="Product/Service" name="groupby_product" context="{'group_by': 'product_id'}"/>
                    <filter string="Encounter" name="groupby_encounter" context="{'group_by': 'encounter_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="action_vet_encounter_line_item" model="ir.actions.act_window">
        <field name="name">Encounter Line Items</field>
        <field name="res_model">vet.encounter.line</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="view_vet_encounter_line_search"/>
        <field name="context">{'search_default_filter_pending': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_info">
                No encounter line items found. Items appear here when an encounter is marked 'Processing'.
            </p>
        </field>
    </record>

    <!-- Encounter Payment Wizard Views -->
    <record id="view_encounter_payment_wizard_form" model="ir.ui.view">
        <field name="name">encounter.payment.wizard.form</field>
        <field name="model">encounter.payment.wizard</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group>
                        <group>
                            <field name="partner_id"/>
                            <field name="payment_type"/>
                            <field name="total_amount" widget="monetary"/>
                            <field name="company_currency" invisible="1"/>
                        </group>
                        <group>
                            <field name="date_from"/>
                            <field name="date_to"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Available Encounters">
                            <field name="encounter_ids" readonly="1">
                                <list>
                                    <field name="name"/>
                                    <field name="encounter_date"/>
                                    <field name="pending_amount"/>
                                    <field name="total_amount"/>
                                </list>
                            </field>
                        </page>
                        <page string="Selected Lines">
                            <field name="line_ids">
                                <list>
                                    <field name="encounter_id"/>
                                    <field name="product_id"/>
                                    <field name="qty"/>
                                    <field name="remaining_amount"/>
                                    <field name="payment_status"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <footer>
                    <button name="action_create_payment_document" string="Create Document" type="object" class="btn-primary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Action for Encounter Payment Wizard -->
    <record id="action_encounter_payment_wizard" model="ir.actions.act_window">
        <field name="name">Create Payment Document</field>
        <field name="res_model">encounter.payment.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

    <!-- Veterinary Encounter Report  -->
    <record id="action_vet_encounter_summary" model="ir.actions.report">
        <field name="name">Encounter Summary</field>
        <field name="model">vet.encounter.header</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ths_vet_base.vet_encounter_summary_template</field>
        <field name="report_file">ths_vet_base.vet_encounter_summary_template</field>
        <field name="binding_model_id" ref="ths_vet_base.model_vet_encounter_header"/>
        <field name="binding_type">report</field>
    </record>

    <template id="vet_encounter_summary_template2">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="encounter">
                <div class="page">
                    <div class="oe_structure"/>

                    <!-- Header -->
                    <div class="row">
                        <div class="col-12">
                            <h2>Encounter Summary</h2>
                            <h3><t t-esc="encounter.name"/></h3>
                        </div>
                    </div>

                    <!-- Pet Owner and Pets Info -->
                    <div class="row mt-3">
                        <div class="col-6">
                            <strong>Pet Owner:</strong> <t t-esc="encounter.pet_owner_id.name"/><br/>
                            <strong>Date:</strong> <t t-esc="encounter.encounter_date"/><br/>
                            <strong>Status:</strong> <t t-esc="encounter.state"/>
                        </div>
                        <div class="col-6">
                            <strong>Pets:</strong><br/>
                            <t t-foreach="encounter.patient_ids" t-as="pet">
                                - <t t-esc="pet.name"/> (<t t-esc="pet.species_id.name"/>)<br/>
                            </t>
                            <strong>Total Amount:</strong>
                            <t t-esc="encounter.total_paid_amount + encounter.total_pending_amount"/>
                            <t t-esc="encounter.company_id.company_currency.symbol"/>
                        </div>
                    </div>

                    <!-- Boarding Stays Section -->
                    <t t-if="encounter.boarding_stay_ids">
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Boarding Stays</h4>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Pet</th>
                                            <th>Cage</th>
                                            <th>Check-in</th>
                                            <th>Check-out</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="encounter.boarding_stay_ids" t-as="boarding">
                                            <tr>
                                                <td><t t-esc="boarding.pet_id.name"/></td>
                                                <td><t t-esc="boarding.cage_id.name"/></td>
                                                <td><t t-esc="boarding.check_in_datetime"
                                                       t-options="{'widget': 'datetime'}"/></td>
                                                <td><t t-esc="boarding.actual_check_out_datetime"
                                                       t-options="{'widget': 'datetime'}"/></td>
                                                <td><t t-esc="boarding.duration_days"/> days</td>
                                                <td><t t-esc="boarding.state"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </t>

                    <!-- Vaccinations Section -->
                    <t t-if="encounter.vaccination_ids">
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Vaccinations</h4>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Pet</th>
                                            <th>Vaccine</th>
                                            <th>Date</th>
                                            <th>Expiry</th>
                                            <th>Veterinarian</th>
                                            <th>Batch</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="encounter.vaccination_ids" t-as="vaccination">
                                            <tr>
                                                <td><t t-esc="vaccination.pet_id.name"/></td>
                                                <td><t t-esc="vaccination.vaccine_type_id.name"/></td>
                                                <td><t t-esc="vaccination.date"/></td>
                                                <td><t t-esc="vaccination.expiry_date"/></td>
                                                <td><t t-esc="vaccination.practitioner_id.name"/></td>
                                                <td><t t-esc="vaccination.batch_number"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </t>

                    <!-- Park Visits Section -->
                    <t t-if="encounter.park_checkin_ids">
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Park Visits</h4>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Pets</th>
                                            <th>Check-in</th>
                                            <th>Check-out</th>
                                            <th>Duration</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="encounter.park_checkin_ids" t-as="park_visit">
                                            <tr>
                                                <td>
                                                    <t t-foreach="park_visit.patient_ids" t-as="pet">
                                                        <t t-esc="pet.name"/><t t-if="not pet_last">, </t>
                                                    </t>
                                                </td>
                                                <td><t t-esc="park_visit.checkin_time"
                                                       t-options="{'widget': 'datetime'}"/></td>
                                                <td><t t-esc="park_visit.checkout_time"
                                                       t-options="{'widget': 'datetime'}"/></td>
                                                <td><t t-esc="park_visit.duration_hours"
                                                       t-options="{'widget': 'float_time'}"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </t>

                    <div class="oe_structure"/>
                </div>
            </t>
        </t>
    </template>

    <!-- New Template Test -->
    <report id="action_report_encounter_summary"
            model="vet.encounter.header"
            string="Encounter Summary"
            report_type="qweb-pdf"
            name="ths_vet_base.vet_encounter_summary_template"
            file="ths_vet_base.vet_encounter_summary_template"/>

    <template id="vet_encounter_summary_template">
        <t t-call="web.external_layout">
            <t t-foreach="docs" t-as="doc">
                <div class="page">
                    <main>
                        <div class="oe_structure"/>
                        <h2>Encounter Summary</h2>
                        <p>Encounter: <span t-field="doc.name"/></p>
                        <p>Date: <span t-field="doc.encounter_date"/></p>
                        <p>Pet Owner: <span t-field="doc.partner_id.name"/></p>
                        <p>Pets: <span t-field="doc.pets_summary"/></p>
                        <p>Practitioner: <span t-field="doc.practitioner_id.name"/></p>
                        <p>Room: <span t-field="doc.room_id.name"/></p>
                        <p>Chief Complaint: <span t-field="doc.chief_complaint"/></p>
                        <p>Subjective: <span t-field="doc.soap_subjective"/></p>
                        <p>Objective: <span t-field="doc.soap_objective"/></p>
                        <p>Assessment: <span t-field="doc.soap_assessment"/></p>
                        <p>Plan: <span t-field="doc.soap_plan"/></p>
                        <p>Vitals:
                            <t t-foreach="doc.vitals_log_ids" t-as="vital">
                                Weight: <span t-field="vital.weight"/>kg,
                                Temperature: <span t-field="vital.temperature"/>Â°C,
                                HR: <span t-field="vital.heart_rate"/>,
                                RR: <span t-field="vital.respiratory_rate"/>
                                Notes: <span t-field="vital.notes"/>
                            </t>
                        </p>
                        <h3>Services &amp; Activities</h3>

                        <!-- Appointments Section -->
                        <t t-if="doc.appointment_ids">
                            <h4>Appointments</h4>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Appointment</th>
                                        <th>Practitioner</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="doc.appointment_ids" t-as="appointment">
                                        <tr>
                                            <td><span t-field="appointment.start" t-options="{'widget': 'datetime', 'show_seconds': False}"/></td>
                                            <td><span t-field="appointment.appointment_type_id.name"/></td>
                                            <td><span t-field="appointment.practitioner_id.name"/></td>
                                            <td><span t-field="appointment.appointment_status"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </t>

                        <t t-if="doc.boarding_stay_ids">
                            <h4>Boarding Stays</h4>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Pet</th>
                                        <th>Cage</th>
                                        <th>Check-in</th>
                                        <th>Check-out</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="doc.boarding_stay_ids" t-as="boarding">
                                        <tr>
                                            <td><span t-esc="', '.join(boarding.patient_ids.mapped('name'))"/></td>
                                            <td><span t-field="boarding.cage_id.name"/></td>
                                            <td><span t-field="boarding.check_in_datetime" t-options="{'widget': 'datetime'}"/></td>
                                            <td><span t-field="boarding.actual_check_out_datetime" t-options="{'widget': 'datetime'}"/></td>
                                            <td><span t-field="boarding.duration_days"/> days</td>
                                            <td><span t-field="boarding.state"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </t>

                        <!-- Vaccinations Section -->
                        <t t-if="doc.vaccination_ids">
                            <h4>Vaccinations Administered</h4>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Pet</th>
                                        <th>Vaccine</th>
                                        <th>Date</th>
                                        <th>Expiry</th>
                                        <th>Batch</th>
                                        <th>Practitioner</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="doc.vaccination_ids" t-as="vaccination">
                                        <tr>
                                            <td><span t-esc="', '.join(vaccination.patient_ids.mapped('name'))"/></td>
                                            <td><span t-field="vaccination.vaccine_type_id.name"/></td>
                                            <td><span t-field="vaccination.date"/></td>
                                            <td><span t-field="vaccination.expiry_date"/></td>
                                            <td><span t-field="vaccination.batch_number"/></td>
                                            <td><span t-field="vaccination.practitioner_id.name"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </t>

                        <!-- Park Check-ins Section -->
                        <t t-if="doc.park_checkin_ids">
                            <h4>Park Visits</h4>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Pets</th>
                                        <th>Check-in</th>
                                        <th>Check-out</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="doc.park_checkin_ids" t-as="park_visit">
                                        <tr>
                                            <td><span t-esc="', '.join(park_visit.patient_ids.mapped('name'))"/></td>
                                            <td><span t-field="park_visit.checkin_time" t-options="{'widget': 'datetime'}"/></td>
                                            <td><span t-field="park_visit.checkout_time" t-options="{'widget': 'datetime'}"/></td>
                                            <td><span t-field="park_visit.duration_hours" t-options="{'widget': 'float_time'}"/></td>
                                            <td><span t-field="park_visit.state"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </t>
                        <!-- Encounter Lines (Services/Products) Section -->
                        <t t-if="doc.encounter_line_ids">
                            <h4>Services &amp; Products Provided</h4>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Service/Product</th>
                                        <th>Pet(s)</th>
                                        <th>Qty</th>
                                        <th>Unit Price</th>
                                        <th>Total</th>
                                        <th>Payment Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="doc.encounter_line_ids" t-as="line">
                                        <tr>
                                            <td><span t-field="line.product_id.name"/></td>
                                            <td><span t-esc="', '.join(line.patient_ids.mapped('name'))"/></td>
                                            <td><span t-field="line.qty"/></td>
                                            <td><span t-field="line.unit_price"/> <span t-field="doc.company_currency.symbol"/></td>
                                            <td><span t-field="line.sub_total"/> <span t-field="doc.company_currency.symbol"/></td>
                                            <td><span t-field="line.payment_status"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                                <tfoot>
                                    <tr class="table-info">
                                        <td colspan="4"><strong>Total Amount</strong></td>
                                        <td><strong><span t-field="doc.total_amount"/> <span t-field="doc.company_currency.symbol"/></strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </t>
                        <div class="oe_structure"/>
                    </main>
                </div>
            </t>
        </t>
    </template>


    <!-- Daily Encounter Summary Report -->
    <record id="action_encounter_daily_summary" model="ir.actions.report">
        <field name="name">Daily Encounter Summary</field>
        <field name="model">vet.encounter.header</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ths_vet_base.encounter_daily_summary_template</field>
        <field name="report_file">ths_vet_base.encounter_daily_summary_template</field>
        <field name="binding_model_id" ref="model_vet_encounter_header"/>
        <field name="binding_type">report</field>
    </record>

    <template id="encounter_daily_summary_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="encounter">
                <div class="page">
                    <div class="oe_structure"/>
                    <!-- Header -->
                    <div class="row">
                        <div class="col-12">
                            <h2>Daily Encounter Summary</h2>
                            <h3><t t-esc="encounter.name"/></h3>
                        </div>
                    </div>

                    <!-- Patient/Customer Info -->
                    <div class="row mt-3">
                        <div class="col-6">
                            <strong>Customer:</strong> <t t-esc="encounter.partner_id.name"/><br/>
                            <strong>Date:</strong> <t t-esc="encounter.encounter_date"/><br/>
                            <strong>Status:</strong> <t t-esc="encounter.state"/>
                        </div>
                        <div class="col-6">
                            <strong>Patients:</strong>
                            <t t-foreach="encounter.patient_ids" t-as="patient">
                                <t t-esc="patient.name"/><t t-if="not patient_last">, </t>
                            </t><br/>
                            <!-- Fixed field names -->
                            <strong>Total Pending:</strong>
                            <t t-esc="encounter.pending_amount"/> <t t-esc="encounter.company_currency.symbol"/><br/>
                            <strong>Total Paid:</strong> <t t-esc="encounter.paid_amount"/> <t t-esc="encounter.company_currency.symbol"/>
                        </div>
                    </div>

                    <!-- Clinical Notes - Fixed field names -->
                    <t t-if="encounter.chief_complaint or encounter.soap_subjective or encounter.soap_objective or encounter.soap_assessment or encounter.soap_plan">
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Clinical Documentation</h4>
                                <t t-if="encounter.chief_complaint">
                                    <p><strong>Chief Complaint:</strong> <t t-esc="encounter.chief_complaint"/></p>
                                </t>
                                <t t-if="encounter.soap_subjective">
                                    <p><strong>Subjective:</strong> <t t-esc="encounter.soap_subjective"/></p>
                                </t>
                                <t t-if="encounter.soap_objective">
                                    <p><strong>Objective:</strong> <t t-esc="encounter.soap_objective"/></p>
                                </t>
                                <t t-if="encounter.soap_assessment">
                                    <p><strong>Assessment:</strong> <t t-esc="encounter.soap_assessment"/></p>
                                </t>
                                <t t-if="encounter.soap_plan">
                                    <p><strong>Plan:</strong> <t t-esc="encounter.soap_plan"/></p>
                                </t>
                            </div>
                        </div>
                    </t>
                    <div class="oe_structure"/>
                </div>
            </t>
        </t>
    </template>

    <!-- Patient History Report -->
    <record id="action_patient_encounter_history" model="ir.actions.report">
        <field name="name">Patient Encounter History</field>
        <field name="model">res.partner</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ths_vet_base.patient_encounter_history_template</field>
        <field name="report_file">ths_vet_base.patient_encounter_history_template</field>
        <field name="binding_model_id" ref="base.model_res_partner"/>
        <field name="binding_type">report</field>
    </record>

    <template id="patient_encounter_history_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="patient">
                <div class="page">
                    <div class="oe_structure"/>

                    <div class="row">
                        <div class="col-12">
                            <h2>Patient Encounter History</h2>
                            <h3><t t-esc="patient.name"/></h3>
                            <p><strong>Patient ID:</strong> <t t-esc="patient.ref"/></p>
                        </div>
                    </div>

                    <t t-set="encounters"
                       t-value="env['vet.encounter.header'].search([('partner_id', '=', patient.id)], order='encounter_date desc')"/>

                    <div class="row mt-3">
                        <div class="col-12">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Services</th>
                                        <th>Status</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="encounters" t-as="encounter">
                                        <tr>
                                            <td><t t-esc="encounter.encounter_date"/></td>
                                            <td>
                                                <t t-if="encounter.appointment_ids">Appointments: <t
                                                        t-esc="len(encounter.appointment_ids)"/><br/></t>
                                                <t t-if="encounter.pos_order_ids">POS Orders: <t
                                                        t-esc="len(encounter.pos_order_ids)"/><br/></t>
                                            </td>
                                            <td><t t-esc="encounter.state"/></td>
                                            <td><t t-esc="encounter.total_paid_amount + encounter.total_pending_amount"/> <t
                                                    t-esc="encounter.company_id.company_currency.symbol"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="oe_structure"/>
                </div>
            </t>
        </t>
    </template>

    <!-- Comprehensive Encounter Report -->
    <template id="vet_encounter_comprehensive_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="encounter">
                <div class="page">
                    <div class="oe_structure"/>
                    <!-- Header with Logo and Clinic Info -->
                    <div class="row">
                        <div class="col-8">
                            <h2>Comprehensive Encounter Report</h2>
                            <h3><t t-esc="encounter.name"/></h3>
                        </div>
                        <div class="col-4 text-right">
                            <t t-set="current_date" t-value="datetime.datetime.now()"/>
                            <p><strong>Date Generated:</strong> <t t-esc="current_date.strftime('%Y-%m-%d %H:%M')"/></p>
                            <p><strong>Generated By:</strong> <t t-esc="user.name"/></p>
                        </div>
                    </div>

                    <!-- Patient and Owner Information -->
                    <div class="row mt-3">
                        <div class="col-6">
                            <h4>Owner Information</h4>
                            <table class="table table-sm table-borderless">
                                <tr><td><strong>Name:</strong></td><td><t t-esc="encounter.partner_id.name"/></td></tr>
                                <tr><td><strong>Phone:</strong></td><td><t t-esc="encounter.partner_id.phone or 'Not provided'"/></td></tr>
                                <tr><td><strong>Mobile:</strong></td><td><t t-esc="encounter.partner_mobile or 'Not provided'"/></td></tr>
                                <tr><td><strong>Email:</strong></td><td><t t-esc="encounter.partner_id.email or 'Not provided'"/></td></tr>
                                <tr><td><strong>Address:</strong></td><td><t t-esc="encounter.partner_id.contact_address or 'Not provided'"/></td></tr>
                            </table>
                        </div>
                        <div class="col-6">
                            <h4>Encounter Details</h4>
                            <table class="table table-sm table-borderless">
                                <tr><td><strong>Date:</strong></td><td><t t-esc="encounter.encounter_date"/></td></tr>
                                <tr><td><strong>Status:</strong></td><td><span t-att-class="'badge badge-success' if encounter.state == 'done' else 'badge badge-info'"><t
                                        t-esc="encounter.state.title()"/></span></td></tr>
                                <tr><td><strong>Practitioner:</strong></td><td><t t-esc="encounter.practitioner_id.name or 'Not assigned'"/></td></tr>
                                <tr><td><strong>Room:</strong></td><td><t t-esc="encounter.room_id.name or 'Not assigned'"/></td></tr>
                                <tr><td><strong>Total Pets:</strong></td><td><t t-esc="encounter.total_pets_count"/></td></tr>
                                <tr><td><strong>Species:</strong></td><td><t t-esc="encounter.all_pets_species or 'N/A'"/></td></tr>
                            </table>
                        </div>
                    </div>

                    <!-- Patient Details -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h4>Patient Information</h4>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Pet Name</th>
                                        <th>Species</th>
                                        <th>Breed</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="encounter.patient_ids" t-as="pet">
                                        <tr>
                                            <td><strong><t t-esc="pet.name"/></strong></td>
                                            <td><t t-esc="pet.species_id.name if pet.species_id else 'Unknown'"/></td>
                                            <td><t t-esc="pet.breed_id.name if pet.breed_id else 'Unknown'"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Vitals Information -->
                    <t t-if="encounter.vitals_log_ids">
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Vital Signs</h4>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Pet</th>
                                            <th>Date/Time</th>
                                            <th>Weight (kg)</th>
                                            <th>Height (cm)</th>
                                            <th>Temperature (C)</th>
                                            <th>Heart Rate (bpm)</th>
                                            <th>Respiratory Rate</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="encounter.vitals_log_ids" t-as="vital">
                                            <tr>
                                                <td><t t-esc="vital.patient_id.name"/></td>
                                                <td><t t-esc="vital.log_date" t-options="{'widget': 'datetime'}"/></td>
                                                <td><t t-esc="vital.weight or '-'"/></td>
                                                <td><t t-esc="vital.height or '-'"/></td>
                                                <td><t t-esc="vital.temperature or '-'"/></td>
                                                <td><t t-esc="vital.heart_rate or '-'"/></td>
                                                <td><t t-esc="vital.respiratory_rate or '-'"/></td>
                                                <td><t t-esc="vital.notes or '-'"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </t>

                    <!-- Clinical Documentation -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h4>Clinical Documentation</h4>
                            <div class="row">
                                <div class="col-6">
                                    <t t-if="encounter.chief_complaint">
                                        <p><strong>Chief Complaint:</strong></p>
                                        <p class="ml-3"><t t-esc="encounter.chief_complaint"/></p>
                                    </t>
                                    <t t-if="encounter.history_illness">
                                        <p><strong>History of Present Illness:</strong></p>
                                        <p class="ml-3"><t t-esc="encounter.history_illness"/></p>
                                    </t>
                                </div>
                                <div class="col-6">
                                    <t t-if="encounter.soap_subjective">
                                        <p><strong>Subjective:</strong></p>
                                        <p class="ml-3"><t t-esc="encounter.soap_subjective"/></p>
                                    </t>
                                    <t t-if="encounter.soap_objective">
                                        <p><strong>Objective:</strong></p>
                                        <p class="ml-3"><t t-esc="encounter.soap_objective"/></p>
                                    </t>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <t t-if="encounter.soap_assessment">
                                        <p><strong>Assessment:</strong></p>
                                        <p class="ml-3"><t t-esc="encounter.soap_assessment"/></p>
                                    </t>
                                </div>
                                <div class="col-6">
                                    <t t-if="encounter.soap_plan">
                                        <p><strong>Plan:</strong></p>
                                        <p class="ml-3"><t t-esc="encounter.soap_plan"/></p>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Services Provided -->
                    <t t-if="encounter.encounter_line_ids">
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Services and Products Provided</h4>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Service/Product</th>
                                            <th>Pet(s)</th>
                                            <th>Practitioner</th>
                                            <th>Qty</th>
                                            <th>Unit Price</th>
                                            <th>Discount</th>
                                            <th>Total</th>
                                            <th>Payment Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="encounter.encounter_line_ids" t-as="line">
                                            <tr>
                                                <td><t t-esc="line.product_id.name"/></td>
                                                <td>
                                                    <t t-foreach="line.patient_ids" t-as="pet">
                                                        <t t-esc="pet.name"/><t t-if="not pet_last">, </t>
                                                    </t>
                                                </td>
                                                <td><t t-esc="line.practitioner_id.name or 'N/A'"/></td>
                                                <td><t t-esc="line.qty"/></td>
                                                <td><t t-esc="line.unit_price"/> <t t-esc="encounter.company_currency.symbol"/></td>
                                                <td><t t-esc="line.discount"/>%</td>
                                                <td><t t-esc="line.sub_total"/> <t t-esc="encounter.company_currency.symbol"/></td>
                                                <td><span
                                                        t-att-class="'badge badge-success' if line.payment_status == 'paid' else 'badge badge-warning' if line.payment_status == 'pending' else 'badge badge-danger'"><t
                                                        t-esc="line.payment_status.title()"/></span></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-info">
                                            <td colspan="6"><strong>Total Amount</strong></td>
                                            <td><strong><t t-esc="encounter.total_amount"/> <t t-esc="encounter.company_currency.symbol"/></strong></td>
                                            <td></td>
                                        </tr>
                                        <tr class="table-warning" t-if="encounter.pending_amount > 0">
                                            <td colspan="6"><strong>Pending Amount</strong></td>
                                            <td><strong><t t-esc="encounter.pending_amount"/> <t t-esc="encounter.company_currency.symbol"/></strong></td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </t>

                    <!-- Vaccinations -->
                    <t t-if="encounter.vaccination_ids">
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Vaccinations Administered</h4>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Pet</th>
                                            <th>Vaccine Type</th>
                                            <th>Date Given</th>
                                            <th>Expiry Date</th>
                                            <th>Batch Number</th>
                                            <th>Practitioner</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="encounter.vaccination_ids" t-as="vaccination">
                                            <tr>
                                                <td><t t-esc="vaccination.patient_ids.mapped('name')" t-options="{'separator': ', '}"/></td>
                                                <td><t t-esc="vaccination.vaccine_type_id.name"/></td>
                                                <td><t t-esc="vaccination.date"/></td>
                                                <td><t t-esc="vaccination.expiry_date"/></td>
                                                <td><t t-esc="vaccination.batch_number or 'N/A'"/></td>
                                                <td><t t-esc="vaccination.practitioner_id.name"/></td>
                                                <td><span t-att-class="'badge badge-danger' if vaccination.is_expired else 'badge badge-success'"><t
                                                        t-esc="'Expired' if vaccination.is_expired else 'Valid'"/></span></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </t>

                    <!-- Appointments -->
                    <t t-if="encounter.appointment_ids">
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Appointments</h4>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Practitioner</th>
                                            <th>Room</th>
                                            <th>Status</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="encounter.appointment_ids" t-as="appointment">
                                            <tr>
                                                <td><t t-esc="appointment.appointment_type_id.name"/></td>
                                                <td><t t-esc="appointment.start" t-options="{'widget': 'datetime'}"/></td>
                                                <td><t t-esc="appointment.stop" t-options="{'widget': 'datetime'}"/></td>
                                                <td><t t-esc="appointment.practitioner_id.name"/></td>
                                                <td><t t-esc="appointment.room_id.name"/></td>
                                                <td><t t-esc="appointment.appointment_status"/></td>
                                                <td><t t-esc="appointment.reason_for_visit.name or 'N/A'"/></td>

                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </t>

                    <!-- Summary Sections -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h4>Clinical Summary</h4>
                            <div class="row">
                                <div class="col-6">
                                    <t t-if="encounter.diagnosis_text">
                                        <p><strong>Diagnoses:</strong></p>
                                        <p class="ml-3"><t t-esc="encounter.diagnosis_text"/></p>
                                    </t>
                                    <t t-if="encounter.procedures_text">
                                        <p><strong>Procedures:</strong></p>
                                        <p class="ml-3"><t t-esc="encounter.procedures_text"/></p>
                                    </t>
                                </div>
                                <div class="col-6">
                                    <t t-if="encounter.prescriptions_text">
                                        <p><strong>Prescriptions:</strong></p>
                                        <p class="ml-3"><t t-esc="encounter.prescriptions_text"/></p>
                                    </t>
                                    <t t-if="encounter.lab_orders_text">
                                        <p><strong>Lab Orders:</strong></p>
                                        <p class="ml-3"><t t-esc="encounter.lab_orders_text"/></p>
                                    </t>
                                    <t t-if="encounter.radiology_orders_text">
                                        <p><strong>Radiology Orders:</strong></p>
                                        <p class="ml-3"><t t-esc="encounter.radiology_orders_text"/></p>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="row mt-5">
                        <div class="col-6">
                            <p><strong>Practitioner Signature:</strong></p>
                            <br/><br/>
                            <p>_________________________</p>
                            <p><t t-esc="encounter.practitioner_id.name if encounter.practitioner_id else 'N/A'"/></p>
                        </div>
                        <div class="col-6">
                            <p><strong>Date:</strong> ________________</p>
                            <br/>
                            <p><strong>Clinic Stamp:</strong></p>
                            <br/><br/>
                        </div>
                    </div>

                    <div class="oe_structure"/>
                </div>
            </t>
        </t>
    </template>

    <!-- Comprehensive Report Action -->
    <record id="action_vet_encounter_comprehensive" model="ir.actions.report">
        <field name="name">Comprehensive Encounter Report</field>
        <field name="model">vet.encounter.header</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ths_vet_base.vet_encounter_comprehensive_template</field>
        <field name="report_file">ths_vet_base.vet_encounter_comprehensive_template</field>
        <field name="binding_model_id" ref="ths_vet_base.model_vet_encounter_header"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="base.paperformat_euro"/>
    </record>

    <!-- TODO: Add encounter profitability analysis report -->
    <!-- TODO: Implement encounter service efficiency metrics -->
    <!-- TODO: Add encounter customer satisfaction integration -->
    <!-- TODO: Implement encounter regulatory compliance reporting -->
    <!-- TODO: Add encounter tax reporting integration -->
    <!-- TODO: Implement encounter export to external accounting systems -->
    <!-- TODO: Add encounter mobile report access -->
    <!-- TODO: Implement encounter automated report scheduling -->


    <!-- vet.vitals.log -->
    <record id="view_vet_vitals_log_list" model="ir.ui.view">
        <field name="name">vet.vitals.log.list</field>
        <field name="model">vet.vitals.log</field>
        <field name="arch" type="xml">
            <list string="Vitals Logs">
                <field name="patient_id"/>
                <field name="log_date"/>
                <field name="weight"/>
                <field name="height"/>
                <field name="temperature"/>
                <field name="heart_rate"/>
                <field name="respiratory_rate"/>
                <field name="notes"/>
            </list>
        </field>
    </record>

    <record id="view_vet_vitals_log_form" model="ir.ui.view">
        <field name="name">vet.vitals.log.form</field>
        <field name="model">vet.vitals.log</field>
        <field name="arch" type="xml">
            <form string="Vitals Log">
                <sheet>
                    <group>
                        <field name="patient_id"/>
                        <field name="log_date"/>
                        <field name="weight"/>
                        <field name="height"/>
                        <field name="temperature"/>
                        <field name="heart_rate"/>
                        <field name="respiratory_rate"/>
                        <field name="notes"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_vet_vitals_log" model="ir.actions.act_window">
        <field name="name">Vitals Logs</field>
        <field name="res_model">vet.vitals.log</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">Create a vitals log entry</p>
        </field>
    </record>

    <!-- encounter.analytics.wizard -->
    <record id="action_encounter_analytics_wizard" model="ir.actions.act_window">
        <field name="name">Encounter Analytics</field>
        <field name="res_model">encounter.analytics.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

    <record id="view_encounter_analytics_wizard_form" model="ir.ui.view">
        <field name="name">encounter.analytics.wizard.form</field>
        <field name="model">encounter.analytics.wizard</field>
        <field name="arch" type="xml">
            <form string="Encounter Analytics">
                <group>
                    <field name="date_filter"/>
                    <field name="date_from" invisible="date_filter != 'custom'"/>
                    <field name="date_to" invisible="date_filter != 'custom'"/>
                </group>
                <footer>
                    <button name="generate_analytics" string="Generate" type="object" class="btn-primary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <template id="report_encounter_analytics_template">
        <t t-call="web.external_layout">
            <t t-foreach="docs" t-as="wizard">
                <div class="page">
                    <div class="oe_structure"/>
                    <main>
                        <!-- Get analytics data directly from the wizard record -->
                        <t t-set="analytics_data" t-value="wizard.analytics_data or {}"/>

                        <div class="row">
                            <div class="col-12 text-center">
                                <h2>Veterinary Encounter Analytics Report</h2>
                                <h4>Period: <t t-esc="analytics_data.get('period_name', 'Custom Period')"/></h4>
                                <p>Generated on: <t t-esc="datetime.datetime.now().strftime('%Y-%m-%d %H:%M')"/> by <t t-esc="user.name"/></p>
                            </div>
                        </div>

                        <!-- Summary Statistics -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h3>Summary Statistics</h3>
                                <div class="row">
                                    <div class="col-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h4 class="card-title"><t t-esc="analytics_data.get('total_encounters', 0)"/></h4>
                                                <p class="card-text">Total Encounters</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h4 class="card-title"><t t-esc="analytics_data.get('total_patients', 0)"/></h4>
                                                <p class="card-text">Unique Patients</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h4 class="card-title"><t t-esc="'%.3f' % analytics_data.get('total_revenue', 0)"/></h4>
                                                <p class="card-text">Total Revenue</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <t t-set="total_revenue" t-value="analytics_data.get('total_revenue', 0)"/>
                                                <t t-set="paid_amount" t-value="analytics_data.get('paid_amount', 0)"/>
                                                <t t-set="collection_rate" t-value="(paid_amount / total_revenue) * 100 if total_revenue > 0 else 0"/>
                                                <h4 class="card-title"><t t-esc="'%.1f' % collection_rate"/>%</h4>
                                                <p class="card-text">Collection Rate</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Breakdown -->
                        <div class="row mt-4">
                            <div class="col-6">
                                <h4>Financial Summary</h4>
                                <table class="table table-sm">
                                    <tr><th>Total Revenue</th><td class="text-right"><t t-esc="'%.3f' % analytics_data.get('total_revenue', 0)"/></td></tr>
                                    <tr><th>Paid Amount</th><td class="text-right text-success"><t t-esc="'%.3f' % analytics_data.get('paid_amount', 0)"/></td></tr>
                                    <tr><th>Pending Amount</th><td class="text-right text-warning"><t t-esc="'%.3f' % analytics_data.get('pending_amount', 0)"/></td></tr>
                                    <tr><th>Returned Amount</th><td class="text-right text-danger"><t t-esc="'%.3f' % analytics_data.get('returned_amount', 0)"/></td></tr>
                                    <tr class="table-info">
                                        <th>Net Revenue</th>
                                        <td class="text-right">
                                            <strong><t t-esc="'%.3f' % (analytics_data.get('paid_amount', 0) - analytics_data.get('returned_amount', 0))"/></strong>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-6">
                                <h4>Service Summary</h4>
                                <table class="table table-sm">
                                    <tr><th>Total Services</th><td class="text-right"><t t-esc="analytics_data.get('total_services', 0)"/></td></tr>
                                    <tr><th>Appointments</th><td class="text-right"><t t-esc="analytics_data.get('total_appointments', 0)"/></td></tr>
                                    <tr><th>Vaccinations</th><td class="text-right"><t t-esc="analytics_data.get('total_vaccinations', 0)"/></td></tr>
                                    <tr><th>Boarding Stays</th><td class="text-right"><t t-esc="analytics_data.get('total_boardings', 0)"/></td></tr>
                                    <tr><th>Park Visits</th><td class="text-right"><t t-esc="analytics_data.get('total_park_visits', 0)"/></td></tr>
                                    <tr><th>Memberships</th><td class="text-right"><t t-esc="analytics_data.get('total_memberships', 0)"/></td></tr>
                                </table>
                            </div>
                        </div>

                        <!-- Performance Metrics -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Performance Metrics</h4>
                                <table class="table table-sm">
                                    <tr>
                                        <th>Average Revenue per Encounter</th>
                                        <t t-set="total_encounters" t-value="analytics_data.get('total_encounters', 0)"/>
                                        <t t-set="avg_revenue" t-value="analytics_data.get('total_revenue', 0) / total_encounters if total_encounters > 0 else 0"/>
                                        <td class="text-right"><t t-esc="'%.3f' % avg_revenue"/></td>
                                    </tr>
                                    <tr>
                                        <th>Average Patients per Encounter</th>
                                        <t t-set="avg_patients" t-value="analytics_data.get('total_patient_visits', 0) / total_encounters if total_encounters > 0 else 0"/>
                                        <td class="text-right"><t t-esc="'%.1f' % avg_patients"/></td>
                                    </tr>
                                    <tr>
                                        <th>Average Services per Encounter</th>
                                        <t t-set="avg_services" t-value="analytics_data.get('total_services', 0) / total_encounters if total_encounters > 0 else 0"/>
                                        <td class="text-right"><t t-esc="'%.1f' % avg_services"/></td>
                                    </tr>
                                    <tr class="table-warning" t-if="analytics_data.get('pending_amount', 0) > 0">
                                        <th>Outstanding Receivables Ratio</th>
                                        <t t-set="total_revenue_calc" t-value="analytics_data.get('total_revenue', 0)"/>
                                        <t t-set="receivables_ratio"
                                           t-value="(analytics_data.get('pending_amount', 0) / total_revenue_calc) * 100 if total_revenue_calc > 0 else 0"/>
                                        <td class="text-right"><t t-esc="'%.1f' % receivables_ratio"/>%</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Period Information -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Report Period Details</h4>
                                <table class="table table-sm">
                                    <tr>
                                        <th>Filter Type</th>
                                        <td><t t-esc="analytics_data.get('date_filter', 'custom').replace('_', ' ').title()"/></td>
                                    </tr>
                                    <tr t-if="analytics_data.get('date_from')">
                                        <th>From Date</th>
                                        <td><t t-esc="analytics_data.get('date_from')"/></td>
                                    </tr>
                                    <tr t-if="analytics_data.get('date_to')">
                                        <th>To Date</th>
                                        <td><t t-esc="analytics_data.get('date_to')"/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Show warning if no data -->
                        <div class="row mt-4" t-if="analytics_data.get('total_encounters', 0) == 0">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h4>No Encounters Found</h4>
                                    <p>No encounters were found for the selected period.</p>
                                    <p><strong>Period:</strong> <t t-esc="analytics_data.get('period_name', 'Unknown')"/></p>
                                </div>
                            </div>
                        </div>
                    </main>
                    <div class="oe_structure"/>
                </div>
            </t>
        </t>
    </template>

    <record id="action_encounter_analytics_report" model="ir.actions.report">
        <field name="name">Encounter Analytics Report</field>
        <field name="model">encounter.analytics.wizard</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ths_vet_base.report_encounter_analytics_template</field>
        <field name="report_file">ths_vet_base.report_encounter_analytics_template</field>
    </record>

    <!-- vet.medical.history.summary -->
    <record id="view_vet_medical_history_summary_list" model="ir.ui.view">
        <field name="name">vet.medical.history.summary.list</field>
        <field name="model">vet.medical.history.summary</field>
        <field name="arch" type="xml">
            <list string="Pet Medical History Summary" create="false" edit="false" delete="false">
                <field name="pet_id"/>
                <field name="owner_id"/>
                <field name="encounter_count"/>
                <field name="last_visit_date" widget="datetime"/>
                <field name="vaccination_count"/>
                <field name="expired_vaccinations" decoration-danger="expired_vaccinations > 0"/>
                <field name="boarding_count"/>
            </list>
        </field>
    </record>

    <record id="action_vet_medical_history_summary" model="ir.actions.act_window">
        <field name="name">Medical History Summary</field>
        <field name="res_model">vet.medical.history.summary</field>
        <field name="view_mode">list</field>
        <field name="help" type="html">
            <p>Overview of all pets' medical histories</p>
        </field>
    </record>

    <!-- account.move -->
    <record id="view_account_move_form_encounter" model="ir.ui.view">
        <field name="name">account.move.form.encounter</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_encounter" type="object" class="oe_stat_button" icon="fa-file-text-o" string="Encounter" invisible="encounter_id == 0"/>
                <button name="action_view_encounter_lines" type="object" class="oe_stat_button" icon="fa-heartbeat" invisible="encounter_line_count == 0">
                    <field name="encounter_line_count" widget="statinfo" string="Encounter Lines"/>
                </button>
                <button name="action_view_credit_notes" type="object" class="oe_stat_button" icon="fa-undo" invisible="not reversal_entry_ids">
                    <field name="reversal_entry_ids" widget="statinfo" string="Refunded Invoice"/>
                </button>
                <button name="action_view_original_invoice" type="object" class="oe_stat_button" icon="fa-file-text-o" invisible="not reversed_entry_id">
                    <div class="o_stat_info">
                        <span class="o_stat_text">Original</span>
                        <span class="o_stat_text">Invoice</span>
                    </div>
                </button>
                <field name="reversal_entry_ids" invisible="1"/>
                <field name="reversed_entry_id" invisible="1"/>
            </xpath>
            <xpath expr="//header" position="inside">
                <button name="action_select_encounter_lines" type="object" string="Add Encounter Lines" class="btn-secondary" invisible="state != 'draft'"/>
            </xpath>
            <xpath expr="//field[@name='name']" position="attributes">
                <attribute name="readonly">1</attribute>
            </xpath>
            <label for="partner_id" position="replace"/>
            <field name="quick_edit_total_amount" position="replace"/>

            <xpath expr="//div[field[@name='partner_id']]" position="replace">
                <group colspan="2">
                    <field name="partner_type_id" options="{'no_open': True, 'no_create': True}" readonly="state == 'posted'"
                           placeholder="Select Partner Type first to see partners..."/>
                    <field name="partner_id" string="Pet Owner" domain="[('partner_type_id', '=?', partner_type_id)]" context="{'show_address': False, 'show_email': False}"
                           readonly="state == 'posted'" options="{'no_open': True, 'no_create': True}" placeholder="Select Pet Owner..."/>
                    <field name="patient_ids" widget="many2many_tags" readonly="state == 'posted'" invisible="move_type not in ('out_invoice', 'out_refund')"/>
                    <field name="practitioner_id" readonly="state == 'posted'"/>
                    <field name="room_id" readonly="state == 'posted'"/>
                    <field name="encounter_id" readonly="state == 'posted'"/>
                    <!--                    <field name="quick_edit_total_amount" string="Total Amount" class="w-50" invisible="move_type == 'entry' or not quick_edit_mode" readonly="state != 'draft'"/>-->
                </group>
                <field name="encounter_line_count" invisible="1"/>
            </xpath>
            <xpath expr="//field[@name='partner_id']" position="attributes">
                <attribute name="context">{'show_address': 0}</attribute>
            </xpath>
            <xpath expr="//field[@name='partner_shipping_id']" position="attributes">
                <attribute name="invisible">move_type == 'out_invoice'</attribute>
            </xpath>
            <xpath expr="//div[@name='journal_div']" position="after">
                <field name="payment_journal_name" string="Payment Journal" invisible="payment_state != 'paid'" readonly="1"/>
                <field name="payment_method_name" string="Payment Method" invisible="payment_state != 'paid'" readonly="1"/>
                <field name="amount_paid" string="Amount Paid" widget="monetary" invisible="payment_state != 'paid'" readonly="1"/>
            </xpath>
            <xpath expr="//field[@name='account_id']" position="attributes">
                <attribute name="optional">hide</attribute>
            </xpath>
            <xpath expr="//field[@name='name']" position="attributes">
                <attribute name="optional">hide</attribute>
            </xpath>
            <xpath expr="//field[@name='analytic_distribution']" position="attributes">
                <attribute name="optional">hide</attribute>
            </xpath>
            <xpath expr="//field[@name='invoice_line_ids']//field[@name='partner_id']" position="attributes">
                <attribute name="column_invisible">0</attribute>
            </xpath>

            <xpath expr="//field[@name='invoice_line_ids']//field[@name='quantity']" position="before">
                <xpath expr="//field[@name='invoice_line_ids']//field[@name='partner_id']" position="move"/>
                <field name="patient_ids" widget="many2many_tags" optional="show"/>
                <field name="practitioner_id" optional="show"/>
                <field name="room_id" optional="hide"/>
            </xpath>

            <!--            <xpath expr="//field[@name='invoice_line_ids']//field[@name='partner_id']" position="after">-->
            <!--                <field name="patient_ids" widget="many2many_tags" optional="show"/>-->
            <!--                <field name="practitioner_id" optional="show"/>-->
            <!--                <field name="room_id" optional="hide"/>-->
            <!--            </xpath>-->


        </field>
    </record>

    <record id="view_account_move_invoice_list_inherit_ths" model="ir.ui.view">
        <field name="name">view.account.move.invoice.list.inherit.ths</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_out_invoice_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='amount_total_in_currency_signed']" position="after">
                <field name="payment_journal_name" optional="show"/>
                <field name="payment_method_name" optional="hide"/>
                <field name="amount_paid" optional="show" widget="monetary" sum="Total Paid"/>
                <field name="practitioner_id" optional="show"/>
                <field name="room_id" optional="hide"/>
            </xpath>
            <xpath expr="//field[@name='invoice_partner_display_name']" position="after">
                <field name="patient_ids" widget="many2many_tags" optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- account.move list view (MAIN JE LIST VIEW) -->
    <record id="view_account_move_list_inherit_ths" model="ir.ui.view">
        <field name="name">view.account.move.list.inherit.ths</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='amount_total_signed']" position="after">
                <field name="payment_journal_name" optional="show"/>
                <field name="payment_method_name" optional="hide"/>
                <field name="amount_paid" optional="show" widget="monetary" sum="Total Paid"/>
                <field name="practitioner_id" optional="show"/>
                <field name="room_id" optional="hide"/>
            </xpath>
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="patient_ids" widget="many2many_tags" optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- sale.order -->
    <record id="view_sale_order_form_encounter" model="ir.ui.view">
        <field name="name">sale.order.form.encounter</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_encounter_lines" type="object" class="oe_stat_button" icon="fa-heartbeat" invisible="encounter_line_count == 0">
                    <field name="encounter_line_count" widget="statinfo" string="Encounter Lines"/>
                </button>
            </xpath>

            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="patient_ids" widget="many2many_tags"/>
                <field name="practitioner_id"/>
                <field name="room_id"/>
                <field name="encounter_id"/>
                <field name="encounter_line_count" invisible="1"/>
            </xpath>

            <xpath expr="//header" position="inside">
                <button name="action_select_encounter_lines" type="object" string="Add Encounter Lines" class="btn-secondary" invisible="state not in ['draft', 'sent']"/>
            </xpath>
        </field>
    </record>

    <!-- Encounter Line Pivot View -->
    <record id="view_encounter_line_pivot_enhanced" model="ir.ui.view">
        <field name="name">vet.encounter.line.pivot.enhanced</field>
        <field name="model">vet.encounter.line</field>
        <field name="arch" type="xml">
            <pivot string="Encounter Line Analysis"
                   display_quantity="1"
                   sample="1">
                <field name="encounter_month" type="row"/>
                <field name="product_id" type="col"/>
                <field name="sub_total" type="measure"/>
                <field name="qty" type="measure"/>
                <field name="discount" widget="percentage"/>
                <field name="revenue_per_patient" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Encounter Line Graph View -->
    <record id="view_encounter_line_graph_enhanced" model="ir.ui.view">
        <field name="name">vet.encounter.line.graph.enhanced</field>
        <field name="model">vet.encounter.line</field>
        <field name="arch" type="xml">
            <graph string="Revenue Analysis"
                   type="line"
                   sample="1"
                   stacked="0">
                <field name="encounter_month"/>
                <field name="sub_total" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Patient Pivot View -->
    <record id="view_patient_pivot_enhanced" model="ir.ui.view">
        <field name="name">res.partner.patient.pivot</field>
        <field name="model">res.partner</field>
        <field name="arch" type="xml">
            <pivot string="Patient Analysis"
                   display_quantity="1"
                   sample="1">
                <field name="species_id" type="row"/>
                <field name="pet_owner_id" type="col"/>
            </pivot>
        </field>
    </record>

    <!-- Patient Species Graph -->
    <record id="view_patient_graph_species" model="ir.ui.view">
        <field name="name">res.partner.patient.graph</field>
        <field name="model">res.partner</field>
        <field name="arch" type="xml">
            <graph string="Patient Distribution"
                   type="pie"
                   sample="1">
                <field name="species_id"/>
            </graph>
        </field>
    </record>


</odoo>